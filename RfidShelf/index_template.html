<!doctype html>
<html><head>
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <script>
     function _(e) {
         return document.getElementById(e);
     }
     function $(q) {
         return Array.from(document.querySelectorAll(q))
     }
     function s(el) {
         el.classList.remove('hidden');
     }
     function h(el) {
         el.classList.add('hidden');
     }
     function t(c, v) {
         $(c).forEach(function (e) {
             e.innerText = v
         })
     }
     function ajax(m, url, cb, p) {
         var xhr = new XMLHttpRequest();
         xhr.onreadystatechange = function () {
             if (xhr.readyState == 4) {
                 cb(xhr.responseText);
             }
         };
         xhr.open(m, url, true);
         xhr.send(p);
     }
     function deleteUrl(url) {
         if (confirm("Delete?")) ajax('DELETE', url, reloadFS);
     }
     function upload() {
         var fileInput = _('fileInput');
         if (fileInput.files.length === 0) {
             alert('Choose a file first');
             return;
         }
         var fileTooLong = false;
         Array.prototype.forEach.call(fileInput.files, function (file) {
             if (file.name.length > 100) {
                 fileTooLong = true;
             }
         });
         if (fileTooLong) {
             alert("File name too long. Files can be max. 100 characters long.");
             return;
         }
         xhr = new XMLHttpRequest();
         var d = new FormData();
         for (var i = 0; i < fileInput.files.length; i++) {
             d.append('data', fileInput.files[i], _('uploadForm').dataset.path + fileInput.files[i].name);
         }
         ;
         xhr.open('POST', '/');
         xhr.upload.addEventListener('progress', progressHandler, false);
         xhr.addEventListener('load', completeHandler, false);
         xhr.addEventListener('error', errorHandler, false);
         xhr.addEventListener('abort', abortHandler, false);
         s(_('ulDiv'));
         xhr.send(d);
     }
     function progressHandler(event) {
         var percentage = Math.round((event.loaded / event.total) * 100);
         _('progressBar').value = percentage;
         _('ulStatus').innerHTML = percentage + '% (' + Math.ceil((event.loaded / (1024 * 1024)) * 10) / 10 + '/' + Math.ceil((event.total / (1024 * 1024)) * 10) / 10 + 'MB) uploaded';
     }
     function completeHandler(event) {
         _('ulStatus').innerHTML = event.target.responseText;
         reloadFS();
         _('uploadForm').reset();
         _('ulStatus').innerText = 'Upload done'
     }
     function errorHandler(event) {
         _('ulStatus').innerText = 'Upload Failed';
     }
     function abortHandler(event) {
         _('ulStatus').innerText = 'Upload Aborted';
     }
     function loadStatus() {
         ajax('GET', '/?status=1', renderStatus)
     }
     function loadFS(url) {
         s(_('loading'));
         h(_('fsContainer'));
         ajax('GET', url + '?fs=1', renderFS)
     }
     function reloadFS() {
         loadFS(_('fs').dataset.path)
     }
     function writeRfidForm() {
         var d = new FormData($('#confCardContainer form')[0]);
         var url = d.get('url');
         if (url.length > 16) {
             alert('Folder name cannot have more than 16 characters');
             return;
         }
         d.append('write', 1);
         ajax('POST', url, function(r) { confNewCard(0); renderStatus(r); }, d);
     }
     function play(url) {
         var d = new FormData();
         d.append('play', 1);
         ajax('POST', url, renderStatus, d);
     }
     function playFile(url) {
         var d = new FormData();
         d.append('playfile', 1);
         ajax('POST', url, renderStatus, d);
     }
     function rootAction(action) {
         var d = new FormData();
         d.append(action, 1);
         ajax('POST', '/', renderStatus, d);
     }
     function mkdir() {
         var f = _('folder').value;
         if (f != '') {
             var d = new FormData();
             d.append('newFolder', f);
             ajax('POST', '/', function () {
                 reloadFS();
                 _('mkdir').reset();
             }, d);
         }
     }
     function ota() {
         s(_('loading'));
         var v = _('otaurl').value;
         if(!v || !v.match(/^http.+\/\//)) v = 1;
         var d = new FormData();
         d.append('ota', v);
         _('spinnerTxt').innerText = 'Please wait and do NOT turn off the power!';
         ajax('POST', '/', function () {
             location.reload();
         }, d);
     }
     function downloadpatch() {
         var xhr = new XMLHttpRequest();
         xhr.onreadystatechange = function () {
             if (xhr.readyState === 1) {
                 document.write('Please wait while downloading patch! When the download was successful the system is automatically restarting.');
             } else if (xhr.readyState === 4) {
                 location.reload();
             }
         };
         xhr.open('POST', '/');
         var formData = new FormData();
         formData.append('downloadpatch', 1);
         xhr.send(formData);
     }
     function formatBytes(a) {
         if (0 == a)return "0 Bytes";
         var c = 1024, e = ["Bytes", "KB", "MB", "GB"], f = Math.floor(Math.log(a) / Math.log(c));
         return parseFloat((a / Math.pow(c, f)).toFixed(2)) + " " + e[f]
     }
     function formatNumbers() {
         $('.number').forEach(function (n) {
             n.innerText = formatBytes(n.innerText);
         })
     }
     function renderFS(r) {
         var p = JSON.parse(r);
         s(_('fsContainer'));
         _('fs').innerHTML = '';
         _('fs').dataset.path = p.path;
         _('uploadForm').dataset.path = p.path + '/';
         p.fs.sort(sortFS);
         p.fs.forEach(renderFSentry);
         formatNumbers();
         if (p.path === '/') {
             s(_('root'));
             h(_('noRoot'));
             $('.file').forEach(function (e) {
                 e.innerHTML = e.innerHTML.replace(/\{path\}/g, '')
             })
         } else {
             h(_('root'));
             s(_('noRoot'));
             $('.file').forEach(function (e) {
                 e.innerHTML = e.innerHTML.replace(/\{path\}/g, p.path)
             })
         }
         h(_('loading'));
     }
     function sortFS(a, b) {
         if (('size' in a) == ('size' in b)) return ('' + a.name).localeCompare(b.name); else if (!('size' in a)) return -1; else return 1;
     }
     function renderFSentry(e) {
         if ('size' in e) {
             var t = document.importNode(_('fileT').content.querySelector('div'), true);
             t.innerHTML = t.innerHTML.replace(/\{filename\}/g, e.name).replace(/\{filesize\}/g, e.size);
             if (e.name.endsWith('.mp3')) {
                 t.classList.add('mp3')
             }
             _('fs').appendChild(t);
         }
         else {
             var t = document.importNode(_('folderT').content.querySelector('div'), true);
             t.innerHTML = t.innerHTML.replace(/\{foldername\}/g, e.name);
             _('fs').appendChild(t);
         }
     }
     function renderStatus(r) {
         var d = JSON.parse(r);
         if ('pairing' in d) {
             t('.pairingFile', '/' + d.pairing);
             s(_('pairing'))
         }
         else {
             h(_('pairing'))
         }
         var pb = _('playback');
         if ('currentFile' in d) {
             t('.currentFile', d.currentFile)
         }
         if (d.playback == 'FILE') {
             pb.className = 'playing'
         }
         else if (d.playback == 'PAUSED') {
             pb.className = 'paused'
         }
         else {
             pb.className = 'hidden'
         }
         if (d.night) {
             h(_('noNight'));
             s(_('night'));
         }
         else {
             s(_('noNight'));
             h(_('night'));
         }
         if (d.random) {
             h(_('noRandom'));
             s(_('random'));
         }
         else {
             s(_('noRandom'));
             h(_('random'));
         }
         _('volumeBar').value = d.volume;
         _('volumeBar').innerHTML = d.volume;
         if (!d.patch) {
             s(_('patchForm'))
         }
         t('.firmwareVersion', d.version);
         t('.shelfTime', (new Date(d.time * 1000)).toUTCString())
     }
     function confNewCard(t, f) {
         var cont = _('confCardContainer');
         if (t) s(cont);
         else { h(cont); return; }
         var sel = _('confCardFolder');
         for(var i = 1; i < sel.options.length; i++) sel.remove(i);
         var addOpt = function(v) {
             var o = document.createElement("option");
             o.text = o.val = v;
             if(v === f) {
                 o.selected = true;
             }
             sel.add(o);
         };
         $('#fs .folder a').forEach(function (e) { addOpt(e.innerText); });
         _('confCardVolume').value = _('volumeBar').value;
     }
     window.onhashchange = function () {
         loadFS(location.hash.slice(1))
     };
</script>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<title>RfidShelf</title>
<style>
 body {
  margin: 0;
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
 }

 #fs > div {
  display: flex;
  align-items: center;
 }

 #fs > div:nth-child(even) {
  background: LightGray;
 }

 #fs {
  background: rgb(250, 250, 250);
 }

 a {
  color: #0000EE;
  text-decoration: none;
 }

 .del {
  background: #ff7272;
 }

 .mp3only, .hiddenPlaying, .hiddenPaused, .hidden {
  display: none;
 }

 .mp3 .mp3only, .playing .hiddenPaused, .paused .hiddenPlaying {
  display: initial;
 }

 #noRandom {
  color: gray;
 }

 #loading {
  background: rgba(255, 255, 255, 0.5);
  position: fixed;
  height: 100%;
  width: 100%;
 }

 #spinner, #spinnerTxt {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
 }

 #spinner {
  border: 20px solid #f3f3f3;
  border-top: 20px solid #0000EE;
  border-radius: 50%;
  width: 120px;
  height: 120px;
  margin: -80px;
  animation: spin 2s linear infinite;
 }

 @keyframes spin {
  0% {
   transform: rotate(0deg);
  }
  50% {
   transform: rotate(360deg);
  }
  100% {
   transform: rotate(0deg);
  }
 }

 body > section {
  padding: 15px 40px;
  overflow: hidden;
 }

 #volume .fl > * {
  margin-left: 5px;
 }

 select,
 input[type=text],
 input[type=submit],
 input[type=file],
 input[type=button] {
  font-size: 14px;
  height: 40px;
  vertical-align: middle;
  display: inline-block;
  max-width: 100%;
  width: 100%;
  padding: 0 10px;
  background: #fff;
  color: #666;
  border: 1px solid #e5e5e5;
  transition: .2s ease-in-out;
  transition-property: color,background-color,border;
 }

 input[type=submit], input[type=button], button {
  background: #1e87f0;
  color: #fff;
  line-height: 38px;
  padding: 0 15px;
 }

 input[type=submit]:hover, button:hover {
  background-color: #0f7ae5;
 }

 .folder::before {
  content: '\1f4c2';
 }

 .mp3::before {
  content: '\266b';
  padding-right: 5px;
 }
 
 .fl {
  display: flex;
  align-items: center;
 }
 
 .fl_exp {
  flex: 1;
 }

 #confCardContainer { position: fixed; top: 0; left: 0; bottom: 0; right: 0; background: rgba(229, 229, 229, 0.8); }
 #confCardContainer form { padding: 10px; border: 1px solid #e5e5e5; max-width: 500px; margin: 30px auto; background: #fafafa; }
 #confCardContainer form > * { margin-bottom: 10px; display: flex; align-items: center; }
 #confCardContainer span { width: 150px; }
</style>
</head><body>
<div id="confCardContainer" class="hidden">
 <form onsubmit="writeRfidForm(); return false;">
  <h3>Configure new card</h3>
  <div>
   <span>Folder:</span>
   <select id="confCardFolder" name="url" class="fl_exp">
    <option>-- Please choose a folder --</option>
   </select>
  </div>
  <div>
   <span>Absolute Volume:</span>
   <input type="text" id="confCardVolume" name="volume" pattern="\d{1,2}" class="fl_exp">
  </div>
  <label>
   <input type="checkbox" name="repeat" value="1" checked="checked">
   Repeat
  </label>
  <label>
   <input type="checkbox" name="shuffle" value="1">
   Shuffle Folder
  </label>
  <label>
    <input type="checkbox" name="stopOnRemove" value="1">
    Play without card
   </label>
  <div>
   <input type="submit" value="Start pairing">
   <button style="background: #e5e5e5; color: #050505; margin-left: 10px;" onclick="confNewCard(0); return false;">close</button>
  </div>
 </form>
</div>
<template id="folderT">
 <div class="folder">
  <a class="fl_exp" href="#/{foldername}">{foldername}</a>
  <div>
   <button class="del" onclick="deleteUrl('{foldername}');" title="delete">&#x2718;</button>
   <button onclick="confNewCard(1, '{foldername}');" title="write to card">&#x1f4be;</button>
   <button onclick="play('{foldername}');" title="play folder">&#x25b6;</button>
  </div>
 </div>
</template>

<template id="fileT">
 <div class="file">
  <div class="fl_exp">
   <a href="{path}/{filename}">{filename}</a> (<span class="number">{filesize}</span>)
  </div>
  <button title="delete" class="del" onclick="deleteUrl('{path}/{filename}');">&#x2718;</button>
  <button title="play" class="mp3only" onclick="playFile('{path}/{filename}');">&#x25b6;</button>
 </div>
</template>

<div id="loading" class="hidden"><div id="spinner"></div><div id="spinnerTxt"></div></div>

<section class="hidden" id="pairing"><strong>Pairing mode active. Place card on shelf to write current configuration for <span class="pairingFile" style="color:red">&nbsp;</span> onto it</strong></section>

<section id="playback" class="hidden">
 <div style="float:left">
  Currently playing: <strong class="currentFile">&nbsp;</strong><br>
 </div>
 <div style="float: right">
  <button class="hiddenPlaying" onclick="rootAction('resume'); return false;">&#x25b6;</button>
  <button class="hiddenPaused" onclick="rootAction('pause'); return false;">&#10073;&#10073;</button>
  <button onclick="rootAction('stop'); return false;">&#x25a0;</button>
  <button onclick="rootAction('skip'); return false;">&#10097;&#10097;</button>
  <button title="deactivate random playback" class="hidden" id="random" onclick="rootAction('toggleRandom'); return false;">&#x1f500;</button>
  <button title="activate random playback" class="hidden" id="noRandom" onclick="rootAction('toggleRandom'); return false;">&#x1f500;</button>
 </div>
</section>

<section id="volume">
 <div class="fl">
  Volume:&nbsp;
  <meter id="volumeBar" value="0" max="50" class="fl_exp">0</meter>
  <button title="decrease volume" onclick="rootAction('volumeDown'); return false;">-</button>
  <button title="increase volume" onclick="rootAction('volumeUp'); return false;">+</button>
  <button title="deactivate night mode" class="hidden" id="night" onclick="rootAction('toggleNight'); return false;">&#x1f31b;</button>
  <button title="activate night mode" class="hidden" id="noNight" onclick="rootAction('toggleNight'); return false;">&#x1f31e;</button>
 </div>
</section>

<section id="fsContainer" class="hidden">
 <h3>SD-Card entries:</h3>
 <div id="fs">File System Loading ...</div>

 <div id="root" class="hidden">
  <form id="mkdir" onsubmit="mkdir(); return false;">
   Create new folder:
   <div class="fl">
    <input type="text" name="folder" id="folder">
    <input type="submit" value="Create" class="fl_exp">
   </div>
  </form>
 </div>

 <div id="noRoot" class="hidden">
  <p><a href="#/">Back to root folder</a></p>
  <form id="uploadForm" onsubmit="upload(); return false;">
   <p>
    Upload MP3 file:
   <div class="fl">
    <input type="file" multiple="true" name="mp3s" accept=".mp3" id="fileInput">
    <input type="submit" value="upload" class="fl_exp">
   </div>
   </p>
   <div id="ulDiv" class="hidden"><progress id="progressBar" value="0" max="100" style="width:300px;"></progress>
    <p id="ulStatus"></p></div>
  </form>
 </div>
</section>

<section>
 <input type="button" title="configure new card" onclick="confNewCard(1); return false;" value="Configure new card"/>
</section>


<section id="patchForm" class="hidden">
 <form onsubmit="downloadpatch(); return false;"><p><strong>MP3 decoder patch missing</strong> (might reduce sound quality) <input type="submit" value="Download + Install VS1053 patch"></p></form>
</section>

<section>
 <form onsubmit="ota(); return false;">
  <p>Version <span class="firmwareVersion">&nbsp;</span>
  <div class="fl">
   <input type="text" id="otaurl" value="https://raw.githubusercontent.com/TheNitek/RfidShelf/master/RfidShelf/build/latest.bin">
   <input type="submit" value="update" class="fl_exp">
  </div>
  </p>
 </form>
</section>

<section>
 <p id="time">Shelf Time: <span class="shelfTime">&nbsp;</span></p>
</section>

<script>loadStatus();
var anchor = location.hash.slice(1);
if (anchor == '') location.hash = '/'; else loadFS(anchor);
</script>

</body>
</html>